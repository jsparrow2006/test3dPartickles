!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports["3dparticles"]=e():t["3dparticles"]=e()}(window,(function(){return function(t){var e={};function r(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,r),a.l=!0,a.exports}return r.m=t,r.c=e,r.d=function(t,e,i){r.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},r.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},r.t=function(t,e){if(1&e&&(t=r(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(r.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)r.d(i,a,function(e){return t[e]}.bind(null,a));return i},r.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return r.d(e,"a",e),e},r.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},r.p="",r(r.s=0)}([function(t,e,r){"use strict";r.r(e),r.d(e,"default",(function(){return _}));var i=function(){var t=["ACTIVE_ATTRIBUTES","ACTIVE_ATTRIBUTE_MAX_LENGTH","ACTIVE_TEXTURE","ACTIVE_UNIFORMS","ACTIVE_UNIFORM_MAX_LENGTH","ALIASED_LINE_WIDTH_RANGE","ALIASED_POINT_SIZE_RANGE","ALPHA","ALPHA_BITS","ALWAYS","ARRAY_BUFFER","ARRAY_BUFFER_BINDING","ATTACHED_SHADERS","BACK","BLEND","BLEND_COLOR","BLEND_DST_ALPHA","BLEND_DST_RGB","BLEND_EQUATION","BLEND_EQUATION_ALPHA","BLEND_EQUATION_RGB","BLEND_SRC_ALPHA","BLEND_SRC_RGB","BLUE_BITS","BOOL","BOOL_VEC2","BOOL_VEC3","BOOL_VEC4","BROWSER_DEFAULT_WEBGL","BUFFER_SIZE","BUFFER_USAGE","BYTE","CCW","CLAMP_TO_EDGE","COLOR_ATTACHMENT0","COLOR_BUFFER_BIT","COLOR_CLEAR_VALUE","COLOR_WRITEMASK","COMPILE_STATUS","COMPRESSED_TEXTURE_FORMATS","CONSTANT_ALPHA","CONSTANT_COLOR","CONTEXT_LOST_WEBGL","CULL_FACE","CULL_FACE_MODE","CURRENT_PROGRAM","CURRENT_VERTEX_ATTRIB","CW","DECR","DECR_WRAP","DELETE_STATUS","DEPTH_ATTACHMENT","DEPTH_BITS","DEPTH_BUFFER_BIT","DEPTH_CLEAR_VALUE","DEPTH_COMPONENT","DEPTH_COMPONENT16","DEPTH_FUNC","DEPTH_RANGE","DEPTH_STENCIL","DEPTH_STENCIL_ATTACHMENT","DEPTH_TEST","DEPTH_WRITEMASK","DITHER","DONT_CARE","DST_ALPHA","DST_COLOR","DYNAMIC_DRAW","ELEMENT_ARRAY_BUFFER","ELEMENT_ARRAY_BUFFER_BINDING","EQUAL","FASTEST","FLOAT","FLOAT_MAT2","FLOAT_MAT3","FLOAT_MAT4","FLOAT_VEC2","FLOAT_VEC3","FLOAT_VEC4","FRAGMENT_SHADER","FRAMEBUFFER","FRAMEBUFFER_ATTACHMENT_OBJECT_NAME","FRAMEBUFFER_ATTACHMENT_OBJECT_TYPE","FRAMEBUFFER_ATTACHMENT_TEXTURE_CUBE_MAP_FACE","FRAMEBUFFER_ATTACHMENT_TEXTURE_LEVEL","FRAMEBUFFER_BINDING","FRAMEBUFFER_COMPLETE","FRAMEBUFFER_INCOMPLETE_ATTACHMENT","FRAMEBUFFER_INCOMPLETE_DIMENSIONS","FRAMEBUFFER_INCOMPLETE_MISSING_ATTACHMENT","FRAMEBUFFER_UNSUPPORTED","FRONT","FRONT_AND_BACK","FRONT_FACE","FUNC_ADD","FUNC_REVERSE_SUBTRACT","FUNC_SUBTRACT","GENERATE_MIPMAP_HINT","GEQUAL","GREATER","GREEN_BITS","HIGH_FLOAT","HIGH_INT","INCR","INCR_WRAP","INFO_LOG_LENGTH","INT","INT_VEC2","INT_VEC3","INT_VEC4","INVALID_ENUM","INVALID_FRAMEBUFFER_OPERATION","INVALID_OPERATION","INVALID_VALUE","INVERT","KEEP","LEQUAL","LESS","LINEAR","LINEAR_MIPMAP_LINEAR","LINEAR_MIPMAP_NEAREST","LINES","LINE_LOOP","LINE_STRIP","LINE_WIDTH","LINK_STATUS","LOW_FLOAT","LOW_INT","LUMINANCE","LUMINANCE_ALPHA","MAX_COMBINED_TEXTURE_IMAGE_UNITS","MAX_CUBE_MAP_TEXTURE_SIZE","MAX_FRAGMENT_UNIFORM_VECTORS","MAX_RENDERBUFFER_SIZE","MAX_TEXTURE_IMAGE_UNITS","MAX_TEXTURE_SIZE","MAX_VARYING_VECTORS","MAX_VERTEX_ATTRIBS","MAX_VERTEX_TEXTURE_IMAGE_UNITS","MAX_VERTEX_UNIFORM_VECTORS","MAX_VIEWPORT_DIMS","MEDIUM_FLOAT","MEDIUM_INT","MIRRORED_REPEAT","NEAREST","NEAREST_MIPMAP_LINEAR","NEAREST_MIPMAP_NEAREST","NEVER","NICEST","NONE","NOTEQUAL","NO_ERROR","NUM_COMPRESSED_TEXTURE_FORMATS","ONE","ONE_MINUS_CONSTANT_ALPHA","ONE_MINUS_CONSTANT_COLOR","ONE_MINUS_DST_ALPHA","ONE_MINUS_DST_COLOR","ONE_MINUS_SRC_ALPHA","ONE_MINUS_SRC_COLOR","OUT_OF_MEMORY","PACK_ALIGNMENT","POINTS","POLYGON_OFFSET_FACTOR","POLYGON_OFFSET_FILL","POLYGON_OFFSET_UNITS","RED_BITS","RENDERBUFFER","RENDERBUFFER_ALPHA_SIZE","RENDERBUFFER_BINDING","RENDERBUFFER_BLUE_SIZE","RENDERBUFFER_DEPTH_SIZE","RENDERBUFFER_GREEN_SIZE","RENDERBUFFER_HEIGHT","RENDERBUFFER_INTERNAL_FORMAT","RENDERBUFFER_RED_SIZE","RENDERBUFFER_STENCIL_SIZE","RENDERBUFFER_WIDTH","RENDERER","REPEAT","REPLACE","RGB","RGB5_A1","RGB565","RGBA","RGBA4","SAMPLER_2D","SAMPLER_CUBE","SAMPLES","SAMPLE_ALPHA_TO_COVERAGE","SAMPLE_BUFFERS","SAMPLE_COVERAGE","SAMPLE_COVERAGE_INVERT","SAMPLE_COVERAGE_VALUE","SCISSOR_BOX","SCISSOR_TEST","SHADER_COMPILER","SHADER_SOURCE_LENGTH","SHADER_TYPE","SHADING_LANGUAGE_VERSION","SHORT","SRC_ALPHA","SRC_ALPHA_SATURATE","SRC_COLOR","STATIC_DRAW","STENCIL_ATTACHMENT","STENCIL_BACK_FAIL","STENCIL_BACK_FUNC","STENCIL_BACK_PASS_DEPTH_FAIL","STENCIL_BACK_PASS_DEPTH_PASS","STENCIL_BACK_REF","STENCIL_BACK_VALUE_MASK","STENCIL_BACK_WRITEMASK","STENCIL_BITS","STENCIL_BUFFER_BIT","STENCIL_CLEAR_VALUE","STENCIL_FAIL","STENCIL_FUNC","STENCIL_INDEX","STENCIL_INDEX8","STENCIL_PASS_DEPTH_FAIL","STENCIL_PASS_DEPTH_PASS","STENCIL_REF","STENCIL_TEST","STENCIL_VALUE_MASK","STENCIL_WRITEMASK","STREAM_DRAW","SUBPIXEL_BITS","TEXTURE","TEXTURE0","TEXTURE1","TEXTURE2","TEXTURE3","TEXTURE4","TEXTURE5","TEXTURE6","TEXTURE7","TEXTURE8","TEXTURE9","TEXTURE10","TEXTURE11","TEXTURE12","TEXTURE13","TEXTURE14","TEXTURE15","TEXTURE16","TEXTURE17","TEXTURE18","TEXTURE19","TEXTURE20","TEXTURE21","TEXTURE22","TEXTURE23","TEXTURE24","TEXTURE25","TEXTURE26","TEXTURE27","TEXTURE28","TEXTURE29","TEXTURE30","TEXTURE31","TEXTURE_2D","TEXTURE_BINDING_2D","TEXTURE_BINDING_CUBE_MAP","TEXTURE_CUBE_MAP","TEXTURE_CUBE_MAP_NEGATIVE_X","TEXTURE_CUBE_MAP_NEGATIVE_Y","TEXTURE_CUBE_MAP_NEGATIVE_Z","TEXTURE_CUBE_MAP_POSITIVE_X","TEXTURE_CUBE_MAP_POSITIVE_Y","TEXTURE_CUBE_MAP_POSITIVE_Z","TEXTURE_MAG_FILTER","TEXTURE_MIN_FILTER","TEXTURE_WRAP_S","TEXTURE_WRAP_T","TRIANGLES","TRIANGLE_FAN","TRIANGLE_STRIP","UNPACK_ALIGNMENT","UNPACK_COLORSPACE_CONVERSION_WEBGL","UNPACK_FLIP_Y_WEBGL","UNPACK_PREMULTIPLY_ALPHA_WEBGL","UNSIGNED_BYTE","UNSIGNED_INT","UNSIGNED_SHORT","UNSIGNED_SHORT_4_4_4_4","UNSIGNED_SHORT_5_5_5_1","UNSIGNED_SHORT_5_6_5","VALIDATE_STATUS","VENDOR","VERSION","VERTEX_ATTRIB_ARRAY_BUFFER_BINDING","VERTEX_ATTRIB_ARRAY_ENABLED","VERTEX_ATTRIB_ARRAY_NORMALIZED","VERTEX_ATTRIB_ARRAY_POINTER","VERTEX_ATTRIB_ARRAY_SIZE","VERTEX_ATTRIB_ARRAY_STRIDE","VERTEX_ATTRIB_ARRAY_TYPE","VERTEX_SHADER","VIEWPORT","ZERO"];function e(e,r){for(var i=this.gl=e.getContext("webgl",r)||e.getContext("experimental-webgl",r),a=0;a<t.length;a+=1)this[t[a]]=i[t[a]];this.changedParameters={},this.parameters={framebuffer:{defaults:[null],setter:function(t){i.bindFramebuffer(i.FRAMEBUFFER,t)},usedInDraw:!0,usedInClear:!0,usedInRead:!0},program:{defaults:[{program:null}],setter:function(t){i.useProgram(t.program)},usedInDraw:!0},viewport:{defaults:[0,0,0,0],setter:i.viewport,usedInDraw:!0},indexBuffer:{defaults:[null],setter:function(t){i.bindBuffer(i.ELEMENT_ARRAY_BUFFER,t)},usedInDraw:!0},depthTest:{defaults:[!1],setter:function(t){t?i.enable(i.DEPTH_TEST):i.disable(i.DEPTH_TEST)},usedInDraw:!0},depthFunc:{defaults:[i.LESS],setter:i.depthFunc,usedInDraw:!0},cullFace:{defaults:[!1],setter:function(t){t?i.enable(i.CULL_FACE):i.disable(i.CULL_FACE)},usedInDraw:!0},frontFace:{defaults:[i.CCW],setter:i.frontFace},blend:{defaults:[!1],setter:function(t){t?i.enable(i.BLEND):i.disable(i.BLEND)},usedInDraw:!0},blendEquation:{defaults:[i.FUNC_ADD,i.FUNC_ADD],setter:i.blendEquationSeparate,usedInDraw:!0},blendFunc:{defaults:[i.ONE,i.ZERO,i.ONE,i.ZERO],setter:i.blendFuncSeparate,usedInDraw:!0},polygonOffsetFill:{defaults:[!1],setter:function(t){t?i.enable(i.POLYGON_OFFSET_FILL):i.disable(i.POLYGON_OFFSET_FILL)},usedInDraw:!0},polygonOffset:{defaults:[0,0],setter:i.polygonOffset,usedInDraw:!0},scissorTest:{defaults:[!1],setter:function(t){t?i.enable(i.SCISSOR_TEST):i.disable(i.SCISSOR_TEST)},usedInDraw:!0,usedInClear:!0},scissor:{defaults:[0,0,0,0],setter:i.scissor,usedInDraw:!0,usedInClear:!0},colorMask:{defaults:[!0,!0,!0,!0],setter:i.colorMask,usedInDraw:!0,usedInClear:!0},depthMask:{defaults:[!0],setter:i.depthMask,usedInDraw:!0,usedInClear:!0},clearColor:{defaults:[0,0,0,0],setter:i.clearColor,usedInClear:!0},clearDepth:{defaults:[1],setter:i.clearDepth,usedInClear:!0}};var s=i.getParameter(i.MAX_VERTEX_ATTRIBS);for(a=0;a<s;++a)this.parameters["attributeArray"+a.toString()]={defaults:[null,0,null,!1,0,0],setter:function(){var t=a;return function(e,r,a,s,n,o){null!==e&&(i.bindBuffer(i.ARRAY_BUFFER,e),i.vertexAttribPointer(t,r,a,s,n,o),i.enableVertexAttribArray(t))}}(),usedInDraw:!0};var n=i.getParameter(i.MAX_TEXTURE_IMAGE_UNITS);for(a=0;a<n;++a)this.parameters["texture"+a.toString()]={defaults:[i.TEXTURE_2D,null],setter:function(){var t=a;return function(e,r){i.activeTexture(i.TEXTURE0+t),i.bindTexture(e,r)}}(),usedInDraw:!0};this.uniformSetters={"1i":i.uniform1i,"2i":i.uniform2i,"3i":i.uniform3i,"4i":i.uniform4i,"1f":i.uniform1f,"2f":i.uniform2f,"3f":i.uniform3f,"4f":i.uniform4f,"1fv":i.uniform1fv,"2fv":i.uniform2fv,"3fv":i.uniform3fv,"4fv":i.uniform4fv,matrix2fv:i.uniformMatrix2fv,matrix3fv:i.uniformMatrix3fv,matrix4fv:i.uniformMatrix4fv},this.defaultTextureUnit=0}function r(t,e,r){var i=t.createShader(e);return t.shaderSource(i,r),t.compileShader(i),t.getShaderParameter(i,t.COMPILE_STATUS)||console.log(t.getShaderInfoLog(i)),i}function i(t,e,i,a){this.uniformLocations={},this.uniforms={};var s=t.gl,n=r(s,s.VERTEX_SHADER,e),o=r(s,s.FRAGMENT_SHADER,i),u=this.program=s.createProgram();if(s.attachShader(u,n),s.attachShader(u,o),void 0!==a)for(var h in a)s.bindAttribLocation(u,a[h],h);s.linkProgram(u),this.attributeLocations={};for(var f=s.getProgramParameter(u,s.ACTIVE_ATTRIBUTES),l=0;l<f;++l){h=s.getActiveAttrib(u,l).name;this.attributeLocations[h]=s.getAttribLocation(u,h)}var c=this.uniformLocations={},E=s.getProgramParameter(u,s.ACTIVE_UNIFORMS);for(l=0;l<E;l+=1){var T=s.getActiveUniform(u,l),m=s.getUniformLocation(u,T.name);c[T.name]=m}}function a(t){this.wgl=t,this.changedParameters={}}function s(t,e){for(var r=0;r<t.length;++r)if(t[r]!==e[r])return!1;return!0}function n(t){a.call(this,t),this.uniforms={}}function o(t){a.call(this,t)}function u(t){a.call(this,t)}return e.checkWebGLSupport=function(t,r){e.checkWebGLSupportWithExtensions([],t,(function(t,e){r()}))},e.checkWebGLSupportWithExtensions=function(t,e,r){var i=document.createElement("canvas"),a=null;try{a=i.getContext("webgl")||i.getContext("experimental-webgl")}catch(t){return void r(!1,[])}if(null!==a){for(var s=[],n=0;n<t.length;++n)null===a.getExtension(t[n])&&s.push(t[n]);s.length>0?r(!0,s):e()}else r(!1,[])},e.prototype.getSupportedExtensions=function(){return this.gl.getSupportedExtensions()},e.prototype.getExtension=function(t){var e=this.gl;if("ANGLE_instanced_arrays"===t){var r=e.getExtension("ANGLE_instanced_arrays");if(null!==r){this.instancedExt=r;for(var i=e.getParameter(e.MAX_VERTEX_ATTRIBS),a=0;a<i;++a)this.parameters["attributeDivisor"+a.toString()]={defaults:[0],setter:function(){var t=a;return function(e){r.vertexAttribDivisorANGLE(t,e)}}(),usedInDraw:!0};return n.prototype.vertexAttribPointer=function(t,e,r,i,a,s,n){return this.setParameter("attributeArray"+e.toString(),[t,r,i,a,s,n]),this.changedParameters.hasOwnProperty("attributeDivisor"+e.toString())&&this.setParameter("attributeDivisor"+e.toString(),[0]),this},n.prototype.vertexAttribDivisorANGLE=function(t,e){return this.setParameter("attributeDivisor"+t.toString(),[e]),this},this.drawArraysInstancedANGLE=function(t,e,r,i,a){this.resolveDrawState(t),this.instancedExt.drawArraysInstancedANGLE(e,r,i,a)},this.drawElementsInstancedANGLE=function(t,e,r,i,a,s){this.resolveDrawState(t),this.instancedExt.drawElementsInstancedANGLE(e,r,i,a,s)},{}}return null}return e.getExtension(t)},e.prototype.resolveState=function(t,e){this.gl;for(var r in this.changedParameters)this.changedParameters.hasOwnProperty(r)&&(t.changedParameters.hasOwnProperty(r)||this.parameters[r][e]&&(this.parameters[r].setter.apply(this.gl,this.parameters[r].defaults),delete this.changedParameters[r]));for(var r in t.changedParameters)t.changedParameters.hasOwnProperty(r)&&(this.changedParameters.hasOwnProperty(r)&&s(this.changedParameters[r],t.changedParameters[r])||(this.changedParameters[r]=t.changedParameters[r],this.parameters[r].setter.apply(this.gl,this.changedParameters[r])))},e.prototype.resolveDrawState=function(t){var e=this.gl;this.resolveState(t,"usedInDraw");var r=t.changedParameters.program[0];for(var i in t.uniforms)if(t.uniforms.hasOwnProperty(i)){var a=[r.uniformLocations[i]].concat(t.uniforms[i].value);this.uniformSetters[t.uniforms[i].type].apply(e,a)}},e.prototype.drawArrays=function(t,e,r,i){this.resolveDrawState(t),this.gl.drawArrays(e,r,i)},e.prototype.drawElements=function(t,e,r,i,a){this.resolveDrawState(t),this.gl.drawElements(e,r,i,a)},e.prototype.resolveClearState=function(t){this.resolveState(t,"usedInClear")},e.prototype.clear=function(t,e){this.resolveClearState(t),this.gl.clear(e)},e.prototype.resolveReadState=function(t){this.resolveState(t,"usedInRead")},e.prototype.readPixels=function(t,e,r,i,a,s,n,o){this.resolveReadState(t),this.gl.readPixels(e,r,i,a,s,n,o)},e.prototype.finish=function(){return this.gl.finish(),this},e.prototype.flush=function(){return this.gl.flush(),this},e.prototype.getError=function(){return this.gl.getError()},e.prototype.createFramebuffer=function(){return this.gl.createFramebuffer()},e.prototype.framebufferTexture2D=function(t,e,r,i,a,s){return this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.changedParameters.framebuffer=t,this.gl.framebufferTexture2D(e,r,i,a,s),this},e.prototype.framebufferRenderbuffer=function(t,e,r,i,a){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.changedParameters.framebuffer=t,this.gl.framebufferRenderbuffer(e,r,i,a)},e.prototype.drawBuffers=function(t,e){this.gl.bindFramebuffer(this.gl.FRAMEBUFFER,t),this.changedParameters.framebuffer=t,this.drawExt.drawBuffersWEBGL(e)},e.prototype.createTexture=function(){return this.gl.createTexture()},e.prototype.bindTextureForEditing=function(t,e){this.gl.activeTexture(this.gl.TEXTURE0+this.defaultTextureUnit),this.gl.bindTexture(t,e),this.changedParameters["texture"+this.defaultTextureUnit.toString()]=[t,e]},e.prototype.texImage2D=function(t,e){var r=Array.prototype.slice.call(arguments,2);return r.unshift(t),this.bindTextureForEditing(t,e),this.gl.texImage2D.apply(this.gl,r),this},e.prototype.texParameteri=function(t,e,r,i){return this.bindTextureForEditing(t,e),this.gl.texParameteri(t,r,i),this},e.prototype.texParameterf=function(t,e,r,i){return this.bindTextureForEditing(t,e),this.gl.texParameterf(t,r,i),this},e.prototype.pixelStorei=function(t,e,r,i){return this.bindTextureForEditing(t,e),this.gl.pixelStorei(r,i),this},e.prototype.setTextureFiltering=function(t,e,r,i,a,s){var n=this.gl;return this.bindTextureForEditing(t,e),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_S,r),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_WRAP_T,i),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MIN_FILTER,a),n.texParameteri(n.TEXTURE_2D,n.TEXTURE_MAG_FILTER,s),this},e.prototype.generateMipmap=function(t,e){return this.bindTextureForEditing(t,e),this.gl.generateMipmap(t),this},e.prototype.buildTexture=function(t,e,r,i,a,s,n,o,u){var h=this.createTexture();return this.rebuildTexture(h,t,e,r,i,a,s,n,o,u),h},e.prototype.rebuildTexture=function(t,e,r,i,a,s,n,o,u,h){return this.texImage2D(this.TEXTURE_2D,t,0,e,i,a,0,e,r,s).setTextureFiltering(this.TEXTURE_2D,t,n,o,u,h),this},e.prototype.createRenderbuffer=function(){return this.gl.createRenderbuffer()},e.prototype.renderbufferStorage=function(t,e,r,i,a){return this.gl.bindRenderbuffer(this.gl.RENDERBUFFER,t),this.gl.renderbufferStorage(e,r,i,a),this},e.prototype.createBuffer=function(){return this.gl.createBuffer()},e.prototype.bufferData=function(t,e,r,i){var a=this.gl;e===a.ARRAY_BUFFER||e===a.ELEMENT_ARRAY_BUFFER&&(this.changedParameters.indexBuffer=[t]),a.bindBuffer(e,t),a.bufferData(e,r,i)},e.prototype.bufferSubData=function(t,e,r,i){var a=this.gl;e===a.ARRAY_BUFFER||e===a.ELEMENT_ARRAY_BUFFER&&(this.changedParameters.indexBuffer=[t]),a.bindBuffer(e,t),a.bufferSubData(e,r,i)},e.prototype.createProgram=function(t,e,r){return new i(this,t,e,r)},e.prototype.createProgramFromFiles=function(t,e,r,i,a){var s=this,n=[];Array.isArray(t)?n=n.concat(t):n.push(t),Array.isArray(e)?n=n.concat(e):n.push(e),function(t,e){for(var r=0,i={},a=0;a<t.length;++a){var s=t[a];!function(){var a=s,n=new XMLHttpRequest;n.onreadystatechange=function(){if(4===n.readyState){var s=n.responseText;i[a]=s,(r+=1)===t.length&&e(i)}},n.open("GET",a,!0),n.send()}()}}(n,(function(a){var n=[];if(Array.isArray(t))for(var o=0;o<t.length;++o)n.push(a[t[o]]);else n.push(a[t]);var u=[];if(Array.isArray(e))for(o=0;o<e.length;++o)u.push(a[e[o]]);else u.push(a[e]);var h=s.createProgram(n.join("\n"),u.join("\n"),r);i(h)}))},e.prototype.createProgramsFromFiles=function(t,e,r){var i=function(t){var e=0;for(var r in t)t.hasOwnProperty(r)&&(e+=1);return e}(t),a=0,s={};for(var n in t)if(t.hasOwnProperty(n)){var o=t[n],u=this;!function(){var t=n;u.createProgramFromFiles(o.vertexShader,o.fragmentShader,o.attributeLocations,(function(r){s[t]=r,++a===i&&e(s)}))}()}},e.prototype.createDrawState=function(){return new n(this)},e.prototype.createClearState=function(){return new o(this)},e.prototype.createReadState=function(){return new u(this)},e.prototype.deleteBuffer=function(t){this.gl.deleteBuffer(t)},e.prototype.deleteFramebuffer=function(t){this.gl.deleteFramebuffer(t)},e.prototype.deleteTexture=function(t){this.gl.deleteTexture(t)},i.prototype.getAttribLocation=function(t){return this.attributeLocations[t]},a.prototype.setParameter=function(t,e){s(e,this.wgl.parameters[t].defaults)?this.changedParameters.hasOwnProperty(t)&&delete this.changedParameters[t]:this.changedParameters[t]=e},a.prototype.clone=function(){var t=new this.constructor(this.wgl);for(var e in this.changedParameters)if(this.changedParameters.hasOwnProperty(e)){for(var r=this.changedParameters[e],i=[],a=0;a<r.length;++a)i.push(r[a]);t.changedParameters[e]=i}return t},n.prototype=Object.create(a.prototype),n.prototype.constructor=a,n.prototype.bindFramebuffer=function(t){return this.setParameter("framebuffer",[t]),this},n.prototype.viewport=function(t,e,r,i){return this.setParameter("viewport",[t,e,r,i]),this},n.prototype.enable=function(t){return t===this.wgl.DEPTH_TEST?this.setParameter("depthTest",[!0]):t===this.wgl.BLEND?this.setParameter("blend",[!0]):t===this.wgl.CULL_FACE?this.setParameter("cullFace",[!0]):t===this.wgl.POLYGON_OFFSET_FILL?this.setParameter("polygonOffsetFill",[!0]):t===this.wgl.SCISSOR_TEST&&this.setParameter("scissorTest",[!0]),this},n.prototype.disable=function(t){return t===this.wgl.DEPTH_TEST?this.setParameter("depthTest",[!1]):t===this.wgl.BLEND?this.setParameter("blend",[!1]):t===this.wgl.CULL_FACE?this.setParameter("cullFace",[!1]):t===this.wgl.POLYGON_OFFSET_FILL?this.setParameter("polygonOffsetFill",[!1]):t===this.wgl.SCISSOR_TEST&&this.setParameter("scissorTest",[!1]),this},n.prototype.vertexAttribPointer=function(t,e,r,i,a,s,n){return this.setParameter("attributeArray"+e.toString(),[t,r,i,a,s,n]),this.instancedExt&&this.changedParameters.hasOwnProperty("attributeDivisor"+e.toString())&&this.setParameter("attributeDivisor"+e.toString(),[0]),this},n.prototype.bindIndexBuffer=function(t){return this.setParameter("indexBuffer",[t]),this},n.prototype.depthFunc=function(t){return this.setParameter("depthFunc",[t]),this},n.prototype.frontFace=function(t){return this.setParameter("frontFace",[t]),this},n.prototype.blendEquation=function(t){return this.blendEquationSeparate(t,t),this},n.prototype.blendEquationSeparate=function(t,e){return this.setParameter("blendEquation",[t,e]),this},n.prototype.blendFunc=function(t,e){return this.blendFuncSeparate(t,e,t,e),this},n.prototype.blendFuncSeparate=function(t,e,r,i){return this.setParameter("blendFunc",[t,e,r,i]),this},n.prototype.scissor=function(t,e,r,i){return this.setParameter("scissor",[t,e,r,i]),this},n.prototype.useProgram=function(t){return this.setParameter("program",[t]),this},n.prototype.bindTexture=function(t,e,r){return this.setParameter("texture"+t.toString(),[e,r]),this},n.prototype.colorMask=function(t,e,r,i){return this.setParameter("colorMask",[t,e,r,i]),this},n.prototype.depthMask=function(t){return this.setParameter("depthMask",[t]),this},n.prototype.polygonOffset=function(t,e){return this.setParameter("polygonOffset",[t,e]),this},n.prototype.uniformTexture=function(t,e,r,i){return this.uniform1i(t,e),this.bindTexture(e,r,i),this},n.prototype.uniform1i=function(t,e){return this.uniforms[t]={type:"1i",value:[e]},this},n.prototype.uniform2i=function(t,e,r){return this.uniforms[t]={type:"2i",value:[e,r]},this},n.prototype.uniform3i=function(t,e,r,i){return this.uniforms[t]={type:"3i",value:[e,r,i]},this},n.prototype.uniform4i=function(t,e,r,i,a){return this.uniforms[t]={type:"4i",value:[e,r,i,a]},this},n.prototype.uniform1f=function(t,e){return this.uniforms[t]={type:"1f",value:e},this},n.prototype.uniform2f=function(t,e,r){return this.uniforms[t]={type:"2f",value:[e,r]},this},n.prototype.uniform3f=function(t,e,r,i){return this.uniforms[t]={type:"3f",value:[e,r,i]},this},n.prototype.uniform4f=function(t,e,r,i,a){return this.uniforms[t]={type:"4f",value:[e,r,i,a]},this},n.prototype.uniform1fv=function(t,e){return this.uniforms[t]={type:"1fv",value:[e]},this},n.prototype.uniform2fv=function(t,e){return this.uniforms[t]={type:"2fv",value:[e]},this},n.prototype.uniform3fv=function(t,e){return this.uniforms[t]={type:"3fv",value:[e]},this},n.prototype.uniform4fv=function(t,e){return this.uniforms[t]={type:"4fv",value:[e]},this},n.prototype.uniformMatrix2fv=function(t,e,r){return this.uniforms[t]={type:"matrix2fv",value:[e,r]},this},n.prototype.uniformMatrix3fv=function(t,e,r){return this.uniforms[t]={type:"matrix3fv",value:[e,r]},this},n.prototype.uniformMatrix4fv=function(t,e,r){return this.uniforms[t]={type:"matrix4fv",value:[e,r]},this},o.prototype=Object.create(a.prototype),o.prototype.constructor=o,o.prototype.bindFramebuffer=function(t){return this.setParameter("framebuffer",[t]),this},o.prototype.clearColor=function(t,e,r,i){return this.setParameter("clearColor",[t,e,r,i]),this},o.prototype.clearDepth=function(t){return this.setParameter("clearDepth",[t]),this},o.prototype.colorMask=function(t,e,r,i){return this.setParameter("colorMask",[t,e,r,i]),this},o.prototype.depthMask=function(t){return this.setParameter("depthMask",[t]),this},u.prototype=Object.create(a.prototype),u.prototype.constructor=u,u.prototype.bindFramebuffer=function(t){return this.setParameter("framebuffer",[t]),this},e}(),a={clamp:function(t,e,r){return Math.max(e,Math.min(r,t))},getMousePosition:function(t,e){var r=e.getBoundingClientRect();return{x:t.clientX-r.left,y:t.clientY-r.top}},addVectors:function(t,e,r){return t[0]=e[0]+r[0],t[1]=e[1]+r[1],t[2]=e[2]+r[2],t},subtractVectors:function(t,e,r){return t[0]=e[0]-r[0],t[1]=e[1]-r[1],t[2]=e[2]-r[2],t},magnitudeOfVector:function(t){return Math.sqrt(t[0]*t[0]+t[1]*t[1]+t[2]*t[2])},dotVectors:function(t,e){return t[0]*e[0]+t[1]*e[1]+t[2]*e[2]},multiplyVectorByScalar:function(t,e,r){return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},normalizeVector:function(t,e){var r=1/a.magnitudeOfVector(e);return t[0]=e[0]*r,t[1]=e[1]*r,t[2]=e[2]*r,t},makePerspectiveMatrix:function(t,e,r,i,a){var s=1/Math.tan(e/2),n=1/(i-a);return t[0]=s/r,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=s,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=(a+i)*n,t[11]=-1,t[12]=0,t[13]=0,t[14]=2*a*i*n,t[15]=0,t},makeIdentityMatrix:function(t){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=1,t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},premultiplyMatrix:function(t,e,r){var i=r[0],a=r[4],s=r[8],n=r[12],o=r[1],u=r[5],h=r[9],f=r[13],l=r[2],c=r[6],E=r[10],T=r[14],m=r[3],d=r[7],p=r[11],_=r[15],g=e[0],R=e[1],x=e[2],A=e[3];return t[0]=i*g+a*R+s*x+n*A,t[1]=o*g+u*R+h*x+f*A,t[2]=l*g+c*R+E*x+T*A,t[3]=m*g+d*R+p*x+_*A,g=e[4],R=e[5],x=e[6],A=e[7],t[4]=i*g+a*R+s*x+n*A,t[5]=o*g+u*R+h*x+f*A,t[6]=l*g+c*R+E*x+T*A,t[7]=m*g+d*R+p*x+_*A,g=e[8],R=e[9],x=e[10],A=e[11],t[8]=i*g+a*R+s*x+n*A,t[9]=o*g+u*R+h*x+f*A,t[10]=l*g+c*R+E*x+T*A,t[11]=m*g+d*R+p*x+_*A,g=e[12],R=e[13],x=e[14],A=e[15],t[12]=i*g+a*R+s*x+n*A,t[13]=o*g+u*R+h*x+f*A,t[14]=l*g+c*R+E*x+T*A,t[15]=m*g+d*R+p*x+_*A,t},makeXRotationMatrix:function(t,e){return t[0]=1,t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=Math.cos(e),t[6]=Math.sin(e),t[7]=0,t[8]=0,t[9]=-Math.sin(e),t[10]=Math.cos(e),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},makeYRotationMatrix:function(t,e){return t[0]=Math.cos(e),t[1]=0,t[2]=-Math.sin(e),t[3]=0,t[4]=0,t[5]=1,t[6]=0,t[7]=0,t[8]=Math.sin(e),t[9]=0,t[10]=Math.cos(e),t[11]=0,t[12]=0,t[13]=0,t[14]=0,t[15]=1,t},transformDirectionByMatrix:function(t,e,r){var i=e[0],a=e[1],s=e[2];return t[0]=r[0]*i+r[4]*a+r[8]*s,t[1]=r[1]*i+r[5]*a+r[9]*s,t[2]=r[2]*i+r[6]*a+r[10]*s,t[3]=r[3]*i+r[7]*a+r[11]*s,t},invertMatrix:function(t,e){var r=e[0],i=e[4],a=e[8],s=e[12],n=e[1],o=e[5],u=e[9],h=e[13],f=e[2],l=e[6],c=e[10],E=e[14],T=e[3],m=e[7],d=e[11],p=e[15],_=c*p,g=E*d,R=l*p,x=E*m,A=l*d,S=c*m,v=f*p,b=E*T,F=f*d,P=c*T,M=f*m,L=l*T,I=a*h,D=s*u,N=i*h,y=s*o,w=i*u,O=a*o,B=r*h,C=s*n,U=r*u,G=a*n,V=r*o,X=i*n,H=_*o+x*u+A*h-(g*o+R*u+S*h),W=g*n+v*u+P*h-(_*n+b*u+F*h),Y=R*n+b*o+M*h-(x*n+v*o+L*h),k=S*n+F*o+L*u-(A*n+P*o+M*u),j=1/(r*H+i*W+a*Y+s*k);return t[0]=j*H,t[1]=j*W,t[2]=j*Y,t[3]=j*k,t[4]=j*(g*i+R*a+S*s-(_*i+x*a+A*s)),t[5]=j*(_*r+b*a+F*s-(g*r+v*a+P*s)),t[6]=j*(x*r+v*i+L*s-(R*r+b*i+M*s)),t[7]=j*(A*r+P*i+M*a-(S*r+F*i+L*a)),t[8]=j*(I*m+y*d+w*p-(D*m+N*d+O*p)),t[9]=j*(D*T+B*d+G*p-(I*T+C*d+U*p)),t[10]=j*(N*T+C*m+V*p-(y*T+B*m+X*p)),t[11]=j*(O*T+U*m+X*d-(w*T+G*m+V*d)),t[12]=j*(N*c+O*E+D*l-(w*E+I*l+y*c)),t[13]=j*(U*E+I*f+C*c-(B*c+G*E+D*f)),t[14]=j*(B*l+X*E+y*f-(V*E+N*f+C*l)),t[15]=j*(V*c+w*f+G*l-(U*l+X*c+O*f)),t},makeLookAtMatrix:function(t,e,r,i){var a=e[0]-r[0],s=e[1]-r[1],n=e[2]-r[2],o=Math.sqrt(a*a+s*s+n*n);a/=o,s/=o,n/=o;var u=i[2]*s-i[1]*n,h=i[0]*n-i[2]*a,f=i[1]*a-i[0]*s,l=Math.sqrt(u*u+h*h+f*f),c=s*(f/=l)-n*(h/=l),E=n*(u/=l)-a*f,T=a*h-s*u,m=Math.sqrt(c*c+E*E+T*T);c/=m,E/=m,T/=m,t[0]=u,t[1]=c,t[2]=a,t[3]=0,t[4]=h,t[5]=E,t[6]=s,t[7]=0,t[8]=f,t[9]=T,t[10]=n,t[11]=0,t[12]=-(u*e[0]+h*e[1]+f*e[2]),t[13]=-(c*e[0]+E*e[1]+T*e[2]),t[14]=-(a*e[0]+s*e[1]+n*e[2]),t[15]=1},makeOrthographicMatrix:function(t,e,r,i,a,s,n){return t[0]=2/(r-e),t[1]=0,t[2]=0,t[3]=0,t[4]=0,t[5]=2/(a-i),t[6]=0,t[7]=0,t[8]=0,t[9]=0,t[10]=-2/(n-s),t[11]=0,t[12]=-(r+e)/(r-e),t[13]=-(a+i)/(a-i),t[14]=-(n+s)/(n-s),t[15]=1,t}},s=function(){function t(t,e,r){this.element=t,this.distance=r.distance,this.orbitPoint=e,this.azimuth=r.azimuth,this.elevation=r.elevation,this.minElevation=-Math.PI/4,this.maxElevation=Math.PI/4,this.currentMouseX=0,this.currentMouseY=0,this.lastMouseX=0,this.lastMouseY=0,this.viewMatrix=new Float32Array(16),this.recomputeViewMatrix()}return t.prototype.recomputeViewMatrix=function(){var t=new Float32Array(16),e=new Float32Array(16),r=a.makeIdentityMatrix(new Float32Array(16)),i=a.makeIdentityMatrix(new Float32Array(16));a.makeIdentityMatrix(this.viewMatrix),a.makeXRotationMatrix(t,this.elevation),a.makeYRotationMatrix(e,this.azimuth),r[14]=-this.distance,i[12]=-this.orbitPoint[0],i[13]=-this.orbitPoint[1],i[14]=-this.orbitPoint[2],a.premultiplyMatrix(this.viewMatrix,this.viewMatrix,i),a.premultiplyMatrix(this.viewMatrix,this.viewMatrix,e),a.premultiplyMatrix(this.viewMatrix,this.viewMatrix,t),a.premultiplyMatrix(this.viewMatrix,this.viewMatrix,r)},t.prototype.getPosition=function(){return[this.distance*Math.sin(Math.PI/2-this.elevation)*Math.sin(-this.azimuth)+this.orbitPoint[0],this.distance*Math.cos(Math.PI/2-this.elevation)+this.orbitPoint[1],this.distance*Math.sin(Math.PI/2-this.elevation)*Math.cos(-this.azimuth)+this.orbitPoint[2]]},t.prototype.getViewMatrix=function(){return this.viewMatrix},t.prototype.setBounds=function(t,e){this.minElevation=t,this.maxElevation=e,this.elevation>this.maxElevation&&(this.elevation=this.maxElevation),this.elevation<this.minElevation&&(this.elevation=this.minElevation),this.recomputeViewMatrix()},t}(),n=function(){function t(t,e){this.min=[t[0],t[1],t[2]],this.max=[e[0],e[1],e[2]]}t.prototype.computeVolume=function(){for(var t=1,e=0;e<3;++e)t*=this.max[e]-this.min[e];return t},t.prototype.computeSurfaceArea=function(){var t=this.max[0]-this.min[0],e=this.max[1]-this.min[1],r=this.max[2]-this.min[2];return 2*(t*e+t*r+e*r)},t.prototype.clone=function(){return new t([this.min[0],this.min[1],this.min[2]],[this.max[0],this.max[1],this.max[2]])},t.prototype.randomPoint=function(){for(var t=[],e=0;e<3;++e)t[e]=this.min[e]+Math.random()*(this.max[e]-this.min[e]);return t};var e={RESIZING:0,TRANSLATING:1,DRAWING:2,EXTRUDING:3};function r(t,e){return t.min[0]<e.max[0]&&t.max[0]>e.min[0]&&t.min[1]<e.max[1]&&t.max[1]>e.min[1]&&t.min[2]<e.max[2]&&t.max[2]>e.min[2]}function i(t,e,r){for(var i=-1/0,a=1/0,s=0,n=0;n<3;++n){var o=(r.min[n]-t[n])/e[n],u=(r.max[n]-t[n])/e[n];if(o>u){var h=o;o=u,u=h}if(u<i||o>a)return null;o>i&&(i=o,s=n),u<a&&(a=u)}if(i>a)return null;var f=[];for(n=0;n<3;++n)f[n]=t[n]+e[n]*i;return{aabb:r,t:i,axis:s,side:e[s]>0?-1:1,point:f}}function s(t,e,r,i){var s=a.subtractVectors([],t,r),n=a.dotVectors(e,e),o=a.dotVectors(e,i),u=a.dotVectors(i,i),h=a.dotVectors(e,s),f=a.dotVectors(i,s),l=(o*f-u*h)/(n*u-o*o),c=(n*f-o*h)/(n*u-o*o);return[a.addVectors([],t,a.multiplyVectorByScalar([],e,l)),a.addVectors([],r,a.multiplyVectorByScalar([],i,c))]}function n(t,e,r,i,a,s,n){this.canvas=t,this.wgl=e,this.gridWidth=a[0],this.gridHeight=a[1],this.gridDepth=a[2],this.gridDimensions=[this.gridWidth,this.gridHeight,this.gridDepth],this.projectionMatrix=r,this.camera=i,this.onChange=n,this.cubeVertexBuffer=e.createBuffer(),e.bufferData(this.cubeVertexBuffer,e.ARRAY_BUFFER,new Float32Array([0,0,1,1,0,1,1,1,1,0,1,1,0,0,0,0,1,0,1,1,0,1,0,0,0,1,0,0,1,1,1,1,1,1,1,0,0,0,0,1,0,0,1,0,1,0,0,1,1,0,0,1,1,0,1,1,1,1,0,1,0,0,0,0,0,1,0,1,1,0,1,0]),e.STATIC_DRAW),this.cubeIndexBuffer=e.createBuffer(),e.bufferData(this.cubeIndexBuffer,e.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,2,0,2,3,4,5,6,4,6,7,8,9,10,8,10,11,12,13,14,12,14,15,16,17,18,16,18,19,20,21,22,20,22,23]),e.STATIC_DRAW),this.cubeWireframeVertexBuffer=e.createBuffer(),e.bufferData(this.cubeWireframeVertexBuffer,e.ARRAY_BUFFER,new Float32Array([0,0,0,1,0,0,1,1,0,0,1,0,0,0,1,1,0,1,1,1,1,0,1,1]),e.STATIC_DRAW),this.cubeWireframeIndexBuffer=e.createBuffer(),e.bufferData(this.cubeWireframeIndexBuffer,e.ELEMENT_ARRAY_BUFFER,new Uint16Array([0,1,1,2,2,3,3,0,4,5,5,6,6,7,7,4,0,4,1,5,2,6,3,7]),e.STATIC_DRAW),this.gridVertexBuffers=[];for(var o=0;o<3;++o){this.gridVertexBuffers[o]=e.createBuffer();var u,h=[];0===o?u=[[0,0,0],[0,this.gridHeight,0],[0,this.gridHeight,this.gridDepth],[0,0,this.gridDepth]]:1===o?u=[[0,0,0],[this.gridWidth,0,0],[this.gridWidth,0,this.gridDepth],[0,0,this.gridDepth]]:2===o&&(u=[[0,0,0],[this.gridWidth,0,0],[this.gridWidth,this.gridHeight,0],[0,this.gridHeight,0]]);for(var f=0;f<4;++f)h.push(u[f][0]),h.push(u[f][1]),h.push(u[f][2]),h.push(u[(f+1)%4][0]),h.push(u[(f+1)%4][1]),h.push(u[(f+1)%4][2]);e.bufferData(this.gridVertexBuffers[o],e.ARRAY_BUFFER,new Float32Array(h),e.STATIC_DRAW)}this.pointVertexBuffer=e.createBuffer(),e.bufferData(this.pointVertexBuffer,e.ARRAY_BUFFER,new Float32Array([-1,-1,0,-1,1,0,1,-1,0,1,1,0]),e.STATIC_DRAW),this.quadVertexBuffer=e.createBuffer(),e.bufferData(this.quadVertexBuffer,e.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,-1,1,1]),e.STATIC_DRAW),this.boxes=[],this.mouseX=999,this.mouseY=999,this.keyPressed=[];for(f=0;f<256;++f)this.keyPressed[f]=!1;this.interactionState=null,e.createProgramsFromFiles({backgroundProgram:{vertexShader:"shaders/background.vert",fragmentShader:"shaders/background.frag"},boxProgram:{vertexShader:"shaders/box.vert",fragmentShader:"shaders/box.frag"},boxWireframeProgram:{vertexShader:"shaders/boxwireframe.vert",fragmentShader:"shaders/boxwireframe.frag"},gridProgram:{vertexShader:"shaders/grid.vert",fragmentShader:"shaders/grid.frag"},pointProgram:{vertexShader:"shaders/point.vert",fragmentShader:"shaders/point.frag"}},function(t){for(var e in t)this[e]=t[e];s()}.bind(this))}function o(t,e){return Math.round(t/e)*e}function u(t,e){for(var r=0;r<t.length;++r)t[r]=o(t[r],e);return t}return n.prototype.onKeyDown=function(t){this.keyPressed[t.keyCode]=!0},n.prototype.onKeyUp=function(t){this.keyPressed[t.keyCode]=!1},n.prototype.onMouseMove=function(i){i.preventDefault();var n=a.getMousePosition(i,this.canvas),h=n.x/this.canvas.width,f=n.y/this.canvas.height;if(this.mouseX=2*h-1,this.mouseY=2*(1-f)-1,null!==this.interactionState)if(this.onChange(),this.interactionState.mode===e.RESIZING||this.interactionState.mode===e.EXTRUDING){var l=this.getMouseRay(),c=this.interactionState.point;(p=[0,0,0])[this.interactionState.axis]=1,_=o(_=s(c,p,l.origin,l.direction)[0][this.interactionState.axis],1);var E=this.interactionState.box,T=this.interactionState.side,m=this.interactionState.axis;-1===T?E.min[m]=Math.max(Math.min(_,E.max[m]),0):1===T&&(E.max[m]=Math.min(Math.max(_,E.min[m]),this.gridDimensions[m]));for(var d=0;d<this.boxes.length;++d){E!==(P=this.boxes[d])&&r(E,P)&&(-1===T?E.min[m]=P.max[m]:1===T&&(E.max[m]=P.min[m]))}}else if(this.interactionState.mode===e.TRANSLATING){var p,_;l=this.getMouseRay(),c=this.interactionState.point;(p=[0,0,0])[this.interactionState.axis]=1,_=o(_=s(c,p,l.origin,l.direction)[0][this.interactionState.axis],1);E=this.interactionState.box,T=this.interactionState.side,m=this.interactionState.axis;var g=this.interactionState.startMax-this.interactionState.startMin;-1===T?(E.min[m]=_,E.max[m]=_+g):1===T&&(E.max[m]=_,E.min[m]=_-g),E.min[m]<0&&(E.min[m]=0,E.max[m]=g),E.max[m]>this.gridDimensions[m]&&(E.max[m]=this.gridDimensions[m],E.min[m]=this.gridDimensions[m]-g);var R=0;-1===T?R=_<this.interactionState.startMin?-1:1:1===T&&(R=_<this.interactionState.startMax?-1:1),(F=E.clone()).min[m]=this.interactionState.startMin,F.max[m]=this.interactionState.startMax,1===R?F.max[m]=E.max[m]:-1===R&&(F.min[m]=E.min[m]);for(d=0;d<this.boxes.length;++d){E!==(P=this.boxes[d])&&r(F,P)&&(-1===R?(E.min[m]=P.max[m],E.max[m]=P.max[m]+g):1===R&&(E.max[m]=P.min[m],E.min[m]=P.min[m]-g))}}else if(this.interactionState.mode===e.DRAWING){l=this.getMouseRay(),m=this.interactionState.axis,T=this.interactionState.side;var x=this.interactionState.point,A=((-1===T?0:this.gridDimensions[m])-l.origin[m])/l.direction[m];if(A>0){var S=a.addVectors([],l.origin,a.multiplyVectorByScalar([],l.direction,A));u(S,1);for(d=0;d<3;++d)S[d]=a.clamp(S[d],0,this.gridDimensions[d]),S[d]=a.clamp(S[d],0,this.gridDimensions[d]);var v=[Math.min(x[0],S[0]),Math.min(x[1],S[1]),Math.min(x[2],S[2])],b=[Math.max(x[0],S[0]),Math.max(x[1],S[1]),Math.max(x[2],S[2])],F=(E=this.interactionState.box,new t(v,b));-1===this.interactionState.side?F.max[this.interactionState.axis]=.1:F.min[this.interactionState.axis]=this.gridDimensions[this.interactionState.axis]-.1;for(d=0;d<this.boxes.length;++d){var P;if(E!==(P=this.boxes[d])&&r(F,P)){var M=99999999,L=-1;for(m=0;m<3;++m)if(m!==this.interactionState.axis){var I=Math.min(b[m],P.max[m])-Math.max(v[m],P.min[m]);I>0&&I<M&&(x[m]<P.min[m]||x[m]>P.max[m])&&(M=I,L=m)}S[L]>x[L]?b[L]=P.min[L]:v[L]=P.max[L]}}this.interactionState.box.min=v,this.interactionState.box.max=b}}this.camera.onMouseMove(i)},n.prototype.getBoxIntersection=function(t,e){for(var r={aabb:null,t:1/0},a=0;a<this.boxes.length;++a){var s=i(t,e,this.boxes[a]);null!==s&&s.t<r.t&&(r=s)}return null===r.aabb?null:r},n.prototype.getBoundingPlaneIntersection=function(t,e){for(var r=0;r<3;++r)for(var i=-1;i<=1;i+=2){if(-1===i?e[r]<0:e[r]>0){var s=((-1===i?0:this.gridDimensions[r])-t[r])/e[r];if(s>0){var n=a.addVectors([],t,a.multiplyVectorByScalar([],e,s));if(n[0]>=0&&n[0]<=this.gridDimensions[0]&&n[1]>=0&&n[1]<=this.gridDimensions[1]&&n[2]>=0&&n[2]<=this.gridDimensions[2])return{axis:r,side:i,point:n}}}}return null},n.prototype.onMouseDown=function(r){if(r.preventDefault(),this.onMouseMove(r),!this.keyPressed[32]){if(null!==this.interactionState&&this.interactionState.mode===e.EXTRUDING)return 0===this.interactionState.box.computeVolume()&&this.boxes.splice(this.boxes.indexOf(this.interactionState.box),1),this.interactionState=null,void this.onChange();var i=this.getMouseRay(),a=this.getBoxIntersection(i.origin,i.direction);if(null!==a){var s=a;this.keyPressed[16]?this.interactionState={mode:e.TRANSLATING,box:s.aabb,axis:s.axis,side:s.side,point:s.point,startMax:s.aabb.max[s.axis],startMin:s.aabb.min[s.axis]}:this.interactionState={mode:e.RESIZING,box:s.aabb,axis:s.axis,side:s.side,point:s.point}}if(null===a){i=this.getMouseRay();var n=this.getBoundingPlaneIntersection(i.origin,i.direction);if(null!==n){var u=n.point;u[0]=o(u[0],1),u[1]=o(u[1],1),u[2]=o(u[2],1);var h=new t(u,u);this.boxes.push(h),this.interactionState={mode:e.DRAWING,box:h,axis:n.axis,side:n.side,point:n.point}}this.onChange()}}null===this.interactionState&&this.camera.onMouseDown(r)},n.prototype.onMouseUp=function(t){if(t.preventDefault(),null!==this.interactionState){if(this.interactionState.mode===e.RESIZING)0===this.interactionState.box.computeVolume()&&this.boxes.splice(this.boxes.indexOf(this.interactionState.box),1),this.interactionState=null;else if(this.interactionState.mode===e.TRANSLATING)this.interactionState=null;else if(this.interactionState.mode===e.DRAWING)if(this.interactionState.box.computeSurfaceArea()>0){var r=this.getMouseRay(),i=this.interactionState.axis,s=this.interactionState.side,n=(this.interactionState.point,((-1===s?0:this.gridDimensions[i])-r.origin[i])/r.direction[i]),o=a.addVectors([],r.origin,a.multiplyVectorByScalar([],r.direction,n));u(o,1);for(var h=0;h<3;++h)o[h]=a.clamp(o[h],0,this.gridDimensions[h]),o[h]=a.clamp(o[h],this.interactionState.box.min[h],this.interactionState.box.max[h]);this.interactionState={mode:e.EXTRUDING,box:this.interactionState.box,axis:this.interactionState.axis,side:-1*this.interactionState.side,point:o}}else this.boxes.splice(this.boxes.indexOf(this.interactionState.box),1),this.interactionState=null;this.onChange()}null===this.interactionState&&this.camera.onMouseUp(t)},n.prototype.getMouseRay=function(){var t=2*Math.atan(1/this.projectionMatrix[5]),e=[this.mouseX*Math.tan(t/2)*(this.canvas.width/this.canvas.height),this.mouseY*Math.tan(t/2),-1],r=a.invertMatrix([],this.camera.getViewMatrix()),i=a.transformDirectionByMatrix([],e,r);return a.normalizeVector(i,i),{origin:this.camera.getPosition(),direction:i}},n.prototype.draw=function(){var t=this.wgl;t.clear(t.createClearState().bindFramebuffer(null).clearColor(.9,.9,.9,1),t.COLOR_BUFFER_BIT|t.DEPTH_BUFFER_BIT);var r=t.createDrawState().bindFramebuffer(null).viewport(0,0,this.canvas.width,this.canvas.height).useProgram(this.backgroundProgram).vertexAttribPointer(this.quadVertexBuffer,this.backgroundProgram.getAttribLocation("a_position"),2,t.FLOAT,t.FALSE,0,0);t.drawArrays(r,t.TRIANGLE_STRIP,0,4);for(var i=0;i<3;++i)for(var s=0;s<=1;++s){var n=this.camera.getPosition(),o=[this.gridWidth/2,this.gridHeight/2,this.gridDepth/2];o[i]=0===s?0:this.gridDimensions[i];var h=a.subtractVectors([],o,n),f=t.createDrawState().bindFramebuffer(null).viewport(0,0,this.canvas.width,this.canvas.height).useProgram(this.gridProgram).vertexAttribPointer(this.gridVertexBuffers[i],this.gridProgram.getAttribLocation("a_vertexPosition"),3,t.FLOAT,t.FALSE,0,0).uniformMatrix4fv("u_projectionMatrix",!1,this.projectionMatrix).uniformMatrix4fv("u_viewMatrix",!1,this.camera.getViewMatrix()),l=[0,0,0];l[i]=s*this.gridDimensions[i],f.uniform3f("u_translation",l[0],l[1],l[2]),(0===s&&h[i]<=0||1===s&&h[i]>=0)&&t.drawArrays(f,t.LINES,0,8)}var c=t.createDrawState().bindFramebuffer(null).viewport(0,0,this.canvas.width,this.canvas.height).enable(t.DEPTH_TEST).enable(t.CULL_FACE).useProgram(this.boxProgram).vertexAttribPointer(this.cubeVertexBuffer,this.boxProgram.getAttribLocation("a_cubeVertexPosition"),3,t.FLOAT,t.FALSE,0,0).bindIndexBuffer(this.cubeIndexBuffer).uniformMatrix4fv("u_projectionMatrix",!1,this.projectionMatrix).uniformMatrix4fv("u_viewMatrix",!1,this.camera.getViewMatrix()).enable(t.POLYGON_OFFSET_FILL).polygonOffset(1,1),E=null,T=null,m=null;if(null!==this.interactionState)this.interactionState.mode!==e.RESIZING&&this.interactionState.mode!==e.EXTRUDING||(E=this.interactionState.box,(T=[1.5,1.5,1.5])[this.interactionState.axis]=this.interactionState.side,m=[.75,.75,.75]);else if(!this.keyPressed[32]&&!this.camera.isMouseDown()){var d=this.getMouseRay(),p=this.getBoxIntersection(d.origin,d.direction);if(null!==p&&(E=p.aabb,(T=[1.5,1.5,1.5])[p.axis]=p.side,m=[.9,.9,.9]),null===p&&!this.keyPressed[32]){var _=this.getBoundingPlaneIntersection(d.origin,d.direction);if(null!==_){var g=_.point;u(g,1);var R=[new Float32Array([0,0,1,0,1,0,1,0,0]),new Float32Array([1,0,0,0,0,1,0,1,0]),new Float32Array([1,0,0,0,1,0,0,0,1])][_.axis],x=t.createDrawState().bindFramebuffer(null).viewport(0,0,this.canvas.width,this.canvas.height).enable(t.DEPTH_TEST).useProgram(this.pointProgram).vertexAttribPointer(this.pointVertexBuffer,this.pointProgram.getAttribLocation("a_position"),3,t.FLOAT,t.FALSE,0,0).uniformMatrix4fv("u_projectionMatrix",!1,this.projectionMatrix).uniformMatrix4fv("u_viewMatrix",!1,this.camera.getViewMatrix()).uniform3f("u_position",g[0],g[1],g[2]).uniformMatrix3fv("u_rotation",!1,R);t.drawArrays(x,t.TRIANGLE_STRIP,0,4)}}}for(var A=0;A<this.boxes.length;++A){var S=this.boxes[A];c.uniform3f("u_translation",S.min[0],S.min[1],S.min[2]).uniform3f("u_scale",S.max[0]-S.min[0],S.max[1]-S.min[1],S.max[2]-S.min[2]),S===E?(c.uniform3f("u_highlightSide",T[0],T[1],T[2]),c.uniform3f("u_highlightColor",m[0],m[1],m[2])):c.uniform3f("u_highlightSide",1.5,1.5,1.5),t.drawElements(c,t.TRIANGLES,36,t.UNSIGNED_SHORT)}var v=t.createDrawState().bindFramebuffer(null).viewport(0,0,this.canvas.width,this.canvas.height).enable(t.DEPTH_TEST).useProgram(this.boxWireframeProgram).vertexAttribPointer(this.cubeWireframeVertexBuffer,this.boxWireframeProgram.getAttribLocation("a_cubeVertexPosition"),3,t.FLOAT,t.FALSE,0,0).bindIndexBuffer(this.cubeWireframeIndexBuffer).uniformMatrix4fv("u_projectionMatrix",!1,this.projectionMatrix).uniformMatrix4fv("u_viewMatrix",!1,this.camera.getViewMatrix());for(A=0;A<this.boxes.length;++A){S=this.boxes[A];v.uniform3f("u_translation",S.min[0],S.min[1],S.min[2]).uniform3f("u_scale",S.max[0]-S.min[0],S.max[1]-S.min[1],S.max[2]-S.min[2]),t.drawElements(v,t.LINES,24,t.UNSIGNED_SHORT)}},{BoxEditor:n,AABB:t,InteractionMode:e}}(),o=function(){function t(t,e,r,i,s){function n(t){t=t.replace(/^#?([a-f\d])([a-f\d])([a-f\d])$/i,(function(t,e,r,i){return e+e+r+r+i+i}));var e=/^#?([a-f\d]{2})([a-f\d]{2})([a-f\d]{2})$/i.exec(t);return e?{r:parseInt(e[1],16)/255,g:parseInt(e[2],16)/255,b:parseInt(e[3],16)/255}:null}console.log(s),this.color1=n(s.color1),this.color2=s.color2?n(s.color2):this.color1,console.log(this.color1),this.canvas=t,this.wgl=e,this.particlesWidth=0,this.particlesHeight=0,this.sphereRadius=10,this.wgl.getExtension("ANGLE_instanced_arrays"),this.depthExt=this.wgl.getExtension("WEBGL_depth_texture"),this.quadVertexBuffer=e.createBuffer(),e.bufferData(this.quadVertexBuffer,e.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,-1,1,1]),e.STATIC_DRAW);var o=this.sphereGeometry=function(t){var e=[],r=[],i=function(t,e){return Math.abs(t[0]-e[0])<.001&&Math.abs(t[1]-e[1])<.001&&Math.abs(t[2]-e[2])<.001},s=function(t){a.normalizeVector(t,t),e.push(t),r.push(t)},n=function(t,r){var n=[(t[0]+r[0])/2,(t[1]+r[1])/2,(t[2]+r[2])/2];a.normalizeVector(n,n);for(var o=0;o<e.length;++o)if(i(e[o],n))return o;return s(n),e.length-1},o=(1+Math.sqrt(5))/2;s([-1,o,0]),s([1,o,0]),s([-1,-o,0]),s([1,-o,0]),s([0,-1,o]),s([0,1,o]),s([0,-1,-o]),s([0,1,-o]),s([o,0,-1]),s([o,0,1]),s([-o,0,-1]),s([-o,0,1]);var u=[];u.push([0,11,5]),u.push([0,5,1]),u.push([0,1,7]),u.push([0,7,10]),u.push([0,10,11]),u.push([1,5,9]),u.push([5,11,4]),u.push([11,10,2]),u.push([10,7,6]),u.push([7,1,8]),u.push([3,9,4]),u.push([3,4,2]),u.push([3,2,6]),u.push([3,6,8]),u.push([3,8,9]),u.push([4,9,5]),u.push([2,4,11]),u.push([6,2,10]),u.push([8,6,7]),u.push([9,8,1]);for(var h=0;h<t;++h){var f=[];for(h=0;h<u.length;++h){var l=u[h],c=n(e[l[0]],e[l[1]]),E=n(e[l[1]],e[l[2]]),T=n(e[l[2]],e[l[0]]);f.push([l[0],c,T]),f.push([l[1],E,c]),f.push([l[2],T,E]),f.push([c,E,T])}u=f}var m=[],d=[],p=[];for(h=0;h<e.length;++h)m.push(e[h][0]),m.push(e[h][1]),m.push(e[h][2]),d.push(r[h][0]),d.push(r[h][1]),d.push(r[h][2]);for(h=0;h<u.length;++h){l=u[h];p.push(l[0]),p.push(l[1]),p.push(l[2])}return{vertices:m,normals:d,indices:p}}(3);this.sphereVertexBuffer=e.createBuffer(),e.bufferData(this.sphereVertexBuffer,e.ARRAY_BUFFER,new Float32Array(o.vertices),e.STATIC_DRAW),this.sphereNormalBuffer=e.createBuffer(),e.bufferData(this.sphereNormalBuffer,e.ARRAY_BUFFER,new Float32Array(o.normals),e.STATIC_DRAW),this.sphereIndexBuffer=e.createBuffer(),e.bufferData(this.sphereIndexBuffer,e.ELEMENT_ARRAY_BUFFER,new Uint16Array(o.indices),e.STATIC_DRAW),this.depthFramebuffer=e.createFramebuffer(),this.depthColorTexture=e.buildTexture(e.RGBA,e.UNSIGNED_BYTE,256,256,null,e.CLAMP_TO_EDGE,e.CLAMP_TO_EDGE,e.LINEAR,e.LINEAR),this.depthTexture=e.buildTexture(e.DEPTH_COMPONENT,e.UNSIGNED_SHORT,256,256,null,e.CLAMP_TO_EDGE,e.CLAMP_TO_EDGE,e.LINEAR,e.LINEAR),this.lightViewMatrix=new Float32Array(16);var u=[r[0]/4,r[1]/4,r[2]/4];a.makeLookAtMatrix(this.lightViewMatrix,u,[u[0],u[1]-1,u[2]],[0,0,1]),this.lightProjectionMatrix=a.makeOrthographicMatrix(new Float32Array(16),-r[0]/2,r[0]/2,-r[2]/2,r[2]/2,-r[1]/2,r[1]/2),this.lightProjectionViewMatrix=new Float32Array(16),a.premultiplyMatrix(this.lightProjectionViewMatrix,this.lightViewMatrix,this.lightProjectionMatrix),this.particleVertexBuffer=e.createBuffer(),this.renderingFramebuffer=e.createFramebuffer(),this.renderingRenderbuffer=e.createRenderbuffer(),this.renderingTexture=e.createTexture(),this.occlusionTexture=e.createTexture(),this.compositingTexture=e.createTexture(),this.onResize(),e.createProgramsFromFiles({sphereProgram:{vertexShader:"shaders/sphere.vert",fragmentShader:"shaders/sphere.frag"},sphereDepthProgram:{vertexShader:"shaders/spheredepth.vert",fragmentShader:"shaders/spheredepth.frag"},sphereAOProgram:{vertexShader:"shaders/sphereao.vert",fragmentShader:"shaders/sphereao.frag"},compositeProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:"shaders/composite.frag",attributeLocations:{a_position:0}},fxaaProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:"shaders/fxaa.frag",attributeLocations:{a_position:0}}},function(t){for(var e in t)this[e]=t[e];i()}.bind(this))}return t.prototype.onResize=function(t){wgl.renderbufferStorage(this.renderingRenderbuffer,wgl.RENDERBUFFER,wgl.DEPTH_COMPONENT16,this.canvas.width,this.canvas.height),wgl.rebuildTexture(this.renderingTexture,wgl.RGBA,wgl.FLOAT,this.canvas.width,this.canvas.height,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.occlusionTexture,wgl.RGBA,wgl.UNSIGNED_BYTE,this.canvas.width,this.canvas.height,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.compositingTexture,wgl.RGBA,wgl.UNSIGNED_BYTE,this.canvas.width,this.canvas.height,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR)},t.prototype.reset=function(t,e,r){this.particlesWidth=t,this.particlesHeight=e,this.sphereRadius=r;this.particlesWidth,this.particlesHeight;for(var i=new Float32Array(this.particlesWidth*this.particlesHeight*2),a=0;a<this.particlesHeight;++a)for(var s=0;s<this.particlesWidth;++s)i[2*(a*this.particlesWidth+s)]=(s+.5)/this.particlesWidth,i[2*(a*this.particlesWidth+s)+1]=(a+.5)/this.particlesHeight;wgl.bufferData(this.particleVertexBuffer,wgl.ARRAY_BUFFER,i,wgl.STATIC_DRAW)},t.prototype.draw=function(t,e,r){var i=this.wgl;a.premultiplyMatrix(new Float32Array(16),r,e);i.framebufferTexture2D(this.renderingFramebuffer,i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.renderingTexture,0),i.framebufferRenderbuffer(this.renderingFramebuffer,i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.RENDERBUFFER,this.renderingRenderbuffer),i.clear(i.createClearState().bindFramebuffer(this.renderingFramebuffer).clearColor(-99999,-99999,-99999,-99999),i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);var s=i.createDrawState().bindFramebuffer(this.renderingFramebuffer).viewport(0,0,this.canvas.width,this.canvas.height).enable(i.DEPTH_TEST).enable(i.CULL_FACE).useProgram(this.sphereProgram).vertexAttribPointer(this.sphereVertexBuffer,this.sphereProgram.getAttribLocation("a_vertexPosition"),3,i.FLOAT,i.FALSE,0,0).vertexAttribPointer(this.sphereNormalBuffer,this.sphereProgram.getAttribLocation("a_vertexNormal"),3,i.FLOAT,i.FALSE,0,0).vertexAttribPointer(this.particleVertexBuffer,this.sphereProgram.getAttribLocation("a_textureCoordinates"),2,i.FLOAT,i.FALSE,0,0).vertexAttribDivisorANGLE(this.sphereProgram.getAttribLocation("a_textureCoordinates"),1).bindIndexBuffer(this.sphereIndexBuffer).uniformMatrix4fv("u_projectionMatrix",!1,e).uniformMatrix4fv("u_viewMatrix",!1,r).uniformTexture("u_positionsTexture",0,i.TEXTURE_2D,t.particlePositionTexture).uniformTexture("u_velocitiesTexture",1,i.TEXTURE_2D,t.particleVelocityTexture).uniform1f("u_sphereRadius",this.sphereRadius);i.drawElementsInstancedANGLE(s,i.TRIANGLES,this.sphereGeometry.indices.length,i.UNSIGNED_SHORT,0,this.particlesWidth*this.particlesHeight),i.framebufferTexture2D(this.renderingFramebuffer,i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.occlusionTexture,0),i.clear(i.createClearState().bindFramebuffer(this.renderingFramebuffer).clearColor(0,0,0,0),i.COLOR_BUFFER_BIT);var n=2*Math.atan(1/e[5]),o=i.createDrawState().bindFramebuffer(this.renderingFramebuffer).viewport(0,0,this.canvas.width,this.canvas.height).enable(i.DEPTH_TEST).depthMask(!1).enable(i.CULL_FACE).enable(i.BLEND).blendEquation(i.FUNC_ADD).blendFuncSeparate(i.ONE,i.ONE,i.ONE,i.ONE).useProgram(this.sphereAOProgram).vertexAttribPointer(this.sphereVertexBuffer,this.sphereAOProgram.getAttribLocation("a_vertexPosition"),3,i.FLOAT,i.FALSE,0,0).vertexAttribPointer(this.particleVertexBuffer,this.sphereAOProgram.getAttribLocation("a_textureCoordinates"),2,i.FLOAT,i.FALSE,0,0).vertexAttribDivisorANGLE(this.sphereAOProgram.getAttribLocation("a_textureCoordinates"),1).bindIndexBuffer(this.sphereIndexBuffer).uniformMatrix4fv("u_projectionMatrix",!1,e).uniformMatrix4fv("u_viewMatrix",!1,r).uniformTexture("u_positionsTexture",0,i.TEXTURE_2D,t.particlePositionTexture).uniformTexture("u_velocitiesTexture",1,i.TEXTURE_2D,t.particleVelocityTexture).uniformTexture("u_renderingTexture",2,i.TEXTURE_2D,this.renderingTexture).uniform2f("u_resolution",this.canvas.width,this.canvas.height).uniform1f("u_fov",n).uniform1f("u_sphereRadius",this.sphereRadius);i.drawElementsInstancedANGLE(o,i.TRIANGLES,this.sphereGeometry.indices.length,i.UNSIGNED_SHORT,0,this.particlesWidth*this.particlesHeight),i.framebufferTexture2D(this.depthFramebuffer,i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.depthColorTexture,0),i.framebufferTexture2D(this.depthFramebuffer,i.FRAMEBUFFER,i.DEPTH_ATTACHMENT,i.TEXTURE_2D,this.depthTexture,0),i.clear(i.createClearState().bindFramebuffer(this.depthFramebuffer).clearColor(0,0,0,0),i.DEPTH_BUFFER_BIT);var u=i.createDrawState().bindFramebuffer(this.depthFramebuffer).viewport(0,0,256,256).enable(i.DEPTH_TEST).depthMask(!0).enable(i.SCISSOR_TEST).scissor(1,1,254,254).colorMask(!1,!1,!1,!1).enable(i.CULL_FACE).useProgram(this.sphereDepthProgram).vertexAttribPointer(this.sphereVertexBuffer,this.sphereDepthProgram.getAttribLocation("a_vertexPosition"),3,i.FLOAT,i.FALSE,0,0).vertexAttribPointer(this.particleVertexBuffer,this.sphereDepthProgram.getAttribLocation("a_textureCoordinates"),2,i.FLOAT,i.FALSE,0,0).vertexAttribDivisorANGLE(this.sphereDepthProgram.getAttribLocation("a_textureCoordinates"),1).bindIndexBuffer(this.sphereIndexBuffer).uniformMatrix4fv("u_projectionViewMatrix",!1,this.lightProjectionViewMatrix).uniformTexture("u_positionsTexture",0,i.TEXTURE_2D,t.particlePositionTexture).uniformTexture("u_velocitiesTexture",1,i.TEXTURE_2D,t.particleVelocityTexture).uniform1f("u_sphereRadius",this.sphereRadius);i.drawElementsInstancedANGLE(u,i.TRIANGLES,this.sphereGeometry.indices.length,i.UNSIGNED_SHORT,0,this.particlesWidth*this.particlesHeight);var h=a.invertMatrix(new Float32Array(16),r);i.framebufferTexture2D(this.renderingFramebuffer,i.FRAMEBUFFER,i.COLOR_ATTACHMENT0,i.TEXTURE_2D,this.compositingTexture,0),i.clear(i.createClearState().bindFramebuffer(this.renderingFramebuffer).clearColor(0,0,0,0),i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);var f=i.createDrawState().bindFramebuffer(this.renderingFramebuffer).viewport(0,0,this.canvas.width,this.canvas.height).useProgram(this.compositeProgram).vertexAttribPointer(this.quadVertexBuffer,0,2,i.FLOAT,i.FALSE,0,0).uniformTexture("u_renderingTexture",0,i.TEXTURE_2D,this.renderingTexture).uniformTexture("u_occlusionTexture",1,i.TEXTURE_2D,this.occlusionTexture).uniform2f("u_resolution",this.canvas.width,this.canvas.height).uniform1f("u_fov",n).uniform3f("u_color1",this.color1.r,this.color1.g,this.color1.b).uniform3f("u_color2",this.color2.r,this.color2.g,this.color2.b).uniformMatrix4fv("u_inverseViewMatrix",!1,h).uniformTexture("u_shadowDepthTexture",2,i.TEXTURE_2D,this.depthTexture).uniform2f("u_shadowResolution",256,256).uniformMatrix4fv("u_lightProjectionViewMatrix",!1,this.lightProjectionViewMatrix);i.drawArrays(f,i.TRIANGLE_STRIP,0,4);h=a.invertMatrix(new Float32Array(16),r);i.clear(i.createClearState().bindFramebuffer(null).clearColor(0,0,0,0),i.COLOR_BUFFER_BIT|i.DEPTH_BUFFER_BIT);var l=i.createDrawState().bindFramebuffer(null).viewport(0,0,this.canvas.width,this.canvas.height).useProgram(this.fxaaProgram).vertexAttribPointer(this.quadVertexBuffer,0,2,i.FLOAT,i.FALSE,0,0).uniformTexture("u_input",0,i.TEXTURE_2D,this.compositingTexture).uniform2f("u_resolution",this.canvas.width,this.canvas.height);i.drawArrays(l,i.TRIANGLE_STRIP,0,4)},t}(),u=function(){function t(t,e){this.wgl=t,this.particlesWidth=0,this.particlesHeight=0,this.gridWidth=0,this.gridHeight=0,this.gridDepth=0,this.gridResolutionX=0,this.gridResolutionY=0,this.gridResolutionZ=0,this.particleDensity=0,this.velocityTextureWidth=0,this.velocityTextureHeight=0,this.scalarTextureWidth=0,this.scalarTextureHeight=0,this.halfFloatExt=this.wgl.getExtension("OES_texture_half_float"),this.wgl.getExtension("OES_texture_half_float_linear"),this.simulationNumberType=this.halfFloatExt.HALF_FLOAT_OES,this.flipness=.99,this.frameNumber=0,this.quadVertexBuffer=t.createBuffer(),t.bufferData(this.quadVertexBuffer,t.ARRAY_BUFFER,new Float32Array([-1,-1,-1,1,1,-1,1,1]),t.STATIC_DRAW),this.simulationFramebuffer=t.createFramebuffer(),this.particleVertexBuffer=t.createBuffer(),this.particlePositionTexture=t.createTexture(),this.particlePositionTextureTemp=t.createTexture(),this.particleVelocityTexture=t.createTexture(),this.particleVelocityTextureTemp=t.createTexture(),this.particleRandomTexture=t.createTexture(),this.velocityTexture=t.createTexture(),this.tempVelocityTexture=t.createTexture(),this.originalVelocityTexture=t.createTexture(),this.weightTexture=t.createTexture(),this.markerTexture=t.createTexture(),this.divergenceTexture=t.createTexture(),this.pressureTexture=t.createTexture(),this.tempSimulationTexture=t.createTexture(),t.createProgramsFromFiles({transferToGridProgram:{vertexShader:"shaders/transfertogrid.vert",fragmentShader:["shaders/common.frag","shaders/transfertogrid.frag"],attributeLocations:{a_textureCoordinates:0}},normalizeGridProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:"shaders/normalizegrid.frag",attributeLocations:{a_position:0}},markProgram:{vertexShader:"shaders/mark.vert",fragmentShader:"shaders/mark.frag",attributeLocations:{a_textureCoordinates:0}},addForceProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:["shaders/common.frag","shaders/addforce.frag"],attributeLocations:{a_position:0}},enforceBoundariesProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:["shaders/common.frag","shaders/enforceboundaries.frag"],attributeLocations:{a_textureCoordinates:0}},extendVelocityProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:"shaders/extendvelocity.frag",attributeLocations:{a_textureCoordinates:0}},transferToParticlesProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:["shaders/common.frag","shaders/transfertoparticles.frag"],attributeLocations:{a_position:0}},divergenceProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:["shaders/common.frag","shaders/divergence.frag"],attributeLocations:{a_position:0}},jacobiProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:["shaders/common.frag","shaders/jacobi.frag"],attributeLocations:{a_position:0}},subtractProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:["shaders/common.frag","shaders/subtract.frag"],attributeLocations:{a_position:0}},advectProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:["shaders/common.frag","shaders/advect.frag"],attributeLocations:{a_position:0}},copyProgram:{vertexShader:"shaders/fullscreen.vert",fragmentShader:"shaders/copy.frag",attributeLocations:{a_position:0}}},function(t){for(var r in t)this[r]=t[r];e()}.bind(this))}function e(t,e,r){var i=t[e];t[e]=t[r],t[r]=i}return t.prototype.reset=function(t,e,r,i,a,s){this.particlesWidth=t,this.particlesHeight=e,this.gridWidth=i[0],this.gridHeight=i[1],this.gridDepth=i[2],this.gridResolutionX=a[0],this.gridResolutionY=a[1],this.gridResolutionZ=a[2],this.particleDensity=s,this.velocityTextureWidth=(this.gridResolutionX+1)*(this.gridResolutionZ+1),this.velocityTextureHeight=this.gridResolutionY+1,this.scalarTextureWidth=this.gridResolutionX*this.gridResolutionZ,this.scalarTextureHeight=this.gridResolutionY;this.particlesWidth,this.particlesHeight;for(var n=new Float32Array(this.particlesWidth*this.particlesHeight*2),o=0;o<this.particlesHeight;++o)for(var u=0;u<this.particlesWidth;++u)n[2*(o*this.particlesWidth+u)]=(u+.5)/this.particlesWidth,n[2*(o*this.particlesWidth+u)+1]=(o+.5)/this.particlesHeight;wgl.bufferData(this.particleVertexBuffer,wgl.ARRAY_BUFFER,n,wgl.STATIC_DRAW);for(var h=new Float32Array(this.particlesWidth*this.particlesHeight*4),f=new Float32Array(this.particlesWidth*this.particlesHeight*4),l=0;l<this.particlesWidth*this.particlesHeight;++l){h[4*l]=r[l][0],h[4*l+1]=r[l][1],h[4*l+2]=r[l][2],h[4*l+3]=0;var c=2*Math.random()*Math.PI,E=2*Math.random()-1;f[4*l]=Math.sqrt(1-E*E)*Math.cos(c),f[4*l+1]=Math.sqrt(1-E*E)*Math.sin(c),f[4*l+2]=E,f[4*l+3]=0}wgl.rebuildTexture(this.particlePositionTexture,wgl.RGBA,wgl.FLOAT,this.particlesWidth,this.particlesHeight,h,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.NEAREST,wgl.NEAREST),wgl.rebuildTexture(this.particlePositionTextureTemp,wgl.RGBA,wgl.FLOAT,this.particlesWidth,this.particlesHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.NEAREST,wgl.NEAREST),wgl.rebuildTexture(this.particleVelocityTexture,wgl.RGBA,this.simulationNumberType,this.particlesWidth,this.particlesHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.NEAREST,wgl.NEAREST),wgl.rebuildTexture(this.particleVelocityTextureTemp,wgl.RGBA,this.simulationNumberType,this.particlesWidth,this.particlesHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.NEAREST,wgl.NEAREST),wgl.rebuildTexture(this.particleRandomTexture,wgl.RGBA,wgl.FLOAT,this.particlesWidth,this.particlesHeight,f,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.NEAREST,wgl.NEAREST),wgl.rebuildTexture(this.velocityTexture,wgl.RGBA,this.simulationNumberType,this.velocityTextureWidth,this.velocityTextureHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.tempVelocityTexture,wgl.RGBA,this.simulationNumberType,this.velocityTextureWidth,this.velocityTextureHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.originalVelocityTexture,wgl.RGBA,this.simulationNumberType,this.velocityTextureWidth,this.velocityTextureHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.weightTexture,wgl.RGBA,this.simulationNumberType,this.velocityTextureWidth,this.velocityTextureHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.markerTexture,wgl.RGBA,wgl.UNSIGNED_BYTE,this.scalarTextureWidth,this.scalarTextureHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.divergenceTexture,wgl.RGBA,this.simulationNumberType,this.scalarTextureWidth,this.scalarTextureHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.pressureTexture,wgl.RGBA,this.simulationNumberType,this.scalarTextureWidth,this.scalarTextureHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR),wgl.rebuildTexture(this.tempSimulationTexture,wgl.RGBA,this.simulationNumberType,this.scalarTextureWidth,this.scalarTextureHeight,null,wgl.CLAMP_TO_EDGE,wgl.CLAMP_TO_EDGE,wgl.LINEAR,wgl.LINEAR)},t.prototype.simulate=function(t,r,i,a){if(0!==t){this.frameNumber+=1;var s=this.wgl,n=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.velocityTextureWidth,this.velocityTextureHeight).vertexAttribPointer(this.particleVertexBuffer,0,2,s.FLOAT,s.FALSE,0,0).useProgram(this.transferToGridProgram).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ).uniform3f("u_gridSize",this.gridWidth,this.gridHeight,this.gridDepth).uniformTexture("u_positionTexture",0,s.TEXTURE_2D,this.particlePositionTexture).uniformTexture("u_velocityTexture",1,s.TEXTURE_2D,this.particleVelocityTexture).enable(s.BLEND).blendEquation(s.FUNC_ADD).blendFuncSeparate(s.ONE,s.ONE,s.ONE,s.ONE);s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.weightTexture,0),s.clear(s.createClearState().bindFramebuffer(this.simulationFramebuffer).clearColor(0,0,0,0),s.COLOR_BUFFER_BIT),n.uniform1i("u_accumulate",0);for(var o=-2;o<=2;++o)n.uniform1f("u_zOffset",o),s.drawArrays(n,s.POINTS,0,this.particlesWidth*this.particlesHeight);s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tempVelocityTexture,0),s.clear(s.createClearState().bindFramebuffer(this.simulationFramebuffer),s.COLOR_BUFFER_BIT),n.uniform1i("u_accumulate",1);for(o=-2;o<=2;++o)n.uniform1f("u_zOffset",o),s.drawArrays(n,s.POINTS,0,this.particlesWidth*this.particlesHeight);s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.velocityTexture,0);var u=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.velocityTextureWidth,this.velocityTextureHeight).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,s.FALSE,0,0).useProgram(this.normalizeGridProgram).uniformTexture("u_weightTexture",0,s.TEXTURE_2D,this.weightTexture).uniformTexture("u_accumulatedVelocityTexture",1,s.TEXTURE_2D,this.tempVelocityTexture);s.drawArrays(u,s.TRIANGLE_STRIP,0,4),s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.markerTexture,0),s.clear(s.createClearState().bindFramebuffer(this.simulationFramebuffer),s.COLOR_BUFFER_BIT);var h=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.scalarTextureWidth,this.scalarTextureHeight).vertexAttribPointer(this.particleVertexBuffer,0,2,s.FLOAT,s.FALSE,0,0).useProgram(this.markProgram).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ).uniform3f("u_gridSize",this.gridWidth,this.gridHeight,this.gridDepth).uniformTexture("u_positionTexture",0,s.TEXTURE_2D,this.particlePositionTexture);s.drawArrays(h,s.POINTS,0,this.particlesWidth*this.particlesHeight),s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.originalVelocityTexture,0);var f=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.velocityTextureWidth,this.velocityTextureHeight).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,s.FALSE,0,0).useProgram(this.copyProgram).uniformTexture("u_texture",0,s.TEXTURE_2D,this.velocityTexture);s.drawArrays(f,s.TRIANGLE_STRIP,0,4),s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tempVelocityTexture,0);var l=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.velocityTextureWidth,this.velocityTextureHeight).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,s.FALSE,0,0).useProgram(this.addForceProgram).uniformTexture("u_velocityTexture",0,s.TEXTURE_2D,this.velocityTexture).uniform1f("u_timeStep",t).uniform3f("u_mouseVelocity",r[0],r[1],r[2]).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ).uniform3f("u_gridSize",this.gridWidth,this.gridHeight,this.gridDepth).uniform3f("u_mouseRayOrigin",i[0],i[1],i[2]).uniform3f("u_mouseRayDirection",a[0],a[1],a[2]);s.drawArrays(l,s.TRIANGLE_STRIP,0,4),e(this,"velocityTexture","tempVelocityTexture"),s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tempVelocityTexture,0);var c=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.velocityTextureWidth,this.velocityTextureHeight).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,s.FALSE,0,0).useProgram(this.enforceBoundariesProgram).uniformTexture("u_velocityTexture",0,s.TEXTURE_2D,this.velocityTexture).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ);s.drawArrays(c,s.TRIANGLE_STRIP,0,4),e(this,"velocityTexture","tempVelocityTexture");var E=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.scalarTextureWidth,this.scalarTextureHeight).useProgram(this.divergenceProgram).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ).uniformTexture("u_velocityTexture",0,s.TEXTURE_2D,this.velocityTexture).uniformTexture("u_markerTexture",1,s.TEXTURE_2D,this.markerTexture).uniformTexture("u_weightTexture",2,s.TEXTURE_2D,this.weightTexture).uniform1f("u_maxDensity",this.particleDensity).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,!1,0,0);s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.divergenceTexture,0),s.clear(s.createClearState().bindFramebuffer(this.simulationFramebuffer),s.COLOR_BUFFER_BIT),s.drawArrays(E,s.TRIANGLE_STRIP,0,4);var T=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.scalarTextureWidth,this.scalarTextureHeight).useProgram(this.jacobiProgram).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ).uniformTexture("u_divergenceTexture",1,s.TEXTURE_2D,this.divergenceTexture).uniformTexture("u_markerTexture",2,s.TEXTURE_2D,this.markerTexture).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,!1,0,0);s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.pressureTexture,0),s.clear(s.createClearState().bindFramebuffer(this.simulationFramebuffer),s.COLOR_BUFFER_BIT);for(var m=0;m<50;++m)s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tempSimulationTexture,0),T.uniformTexture("u_pressureTexture",0,s.TEXTURE_2D,this.pressureTexture),s.drawArrays(T,s.TRIANGLE_STRIP,0,4),e(this,"pressureTexture","tempSimulationTexture");s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.tempVelocityTexture,0);var d=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.velocityTextureWidth,this.velocityTextureHeight).useProgram(this.subtractProgram).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ).uniformTexture("u_pressureTexture",0,s.TEXTURE_2D,this.pressureTexture).uniformTexture("u_velocityTexture",1,s.TEXTURE_2D,this.velocityTexture).uniformTexture("u_markerTexture",2,s.TEXTURE_2D,this.markerTexture).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,!1,0,0);s.drawArrays(d,s.TRIANGLE_STRIP,0,4),e(this,"velocityTexture","tempVelocityTexture"),s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.particleVelocityTextureTemp,0);var p=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.particlesWidth,this.particlesHeight).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,s.FALSE,0,0).useProgram(this.transferToParticlesProgram).uniformTexture("u_particlePositionTexture",0,s.TEXTURE_2D,this.particlePositionTexture).uniformTexture("u_particleVelocityTexture",1,s.TEXTURE_2D,this.particleVelocityTexture).uniformTexture("u_gridVelocityTexture",2,s.TEXTURE_2D,this.velocityTexture).uniformTexture("u_originalGridVelocityTexture",3,s.TEXTURE_2D,this.originalVelocityTexture).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ).uniform3f("u_gridSize",this.gridWidth,this.gridHeight,this.gridDepth).uniform1f("u_flipness",this.flipness);s.drawArrays(p,s.TRIANGLE_STRIP,0,4),e(this,"particleVelocityTextureTemp","particleVelocityTexture"),s.framebufferTexture2D(this.simulationFramebuffer,s.FRAMEBUFFER,s.COLOR_ATTACHMENT0,s.TEXTURE_2D,this.particlePositionTextureTemp,0),s.clear(s.createClearState().bindFramebuffer(this.simulationFramebuffer),s.COLOR_BUFFER_BIT);var _=s.createDrawState().bindFramebuffer(this.simulationFramebuffer).viewport(0,0,this.particlesWidth,this.particlesHeight).vertexAttribPointer(this.quadVertexBuffer,0,2,s.FLOAT,s.FALSE,0,0).useProgram(this.advectProgram).uniformTexture("u_positionsTexture",0,s.TEXTURE_2D,this.particlePositionTexture).uniformTexture("u_randomsTexture",1,s.TEXTURE_2D,this.particleRandomTexture).uniformTexture("u_velocityGrid",2,s.TEXTURE_2D,this.velocityTexture).uniform3f("u_gridResolution",this.gridResolutionX,this.gridResolutionY,this.gridResolutionZ).uniform3f("u_gridSize",this.gridWidth,this.gridHeight,this.gridDepth).uniform1f("u_timeStep",t).uniform1f("u_frameNumber",this.frameNumber).uniform2f("u_particlesResolution",this.particlesWidth,this.particlesHeight);s.drawArrays(_,s.TRIANGLE_STRIP,0,4),e(this,"particlePositionTextureTemp","particlePositionTexture")}},t}(),h=function(){function t(t,e,r,i,a,s,n){this.canvas=t,this.wgl=e,this.projectionMatrix=r,this.camera=i,e.getExtension("OES_texture_float"),e.getExtension("OES_texture_float_linear");var h=!1,f=!1;function l(){this.mouseX=0,this.mouseY=0,this.lastMousePlaneX=0,this.lastMousePlaneY=0,setTimeout(s,1)}this.renderer=new o(this.canvas,this.wgl,a,function(){(h=!0)&&f&&l.call(this)}.bind(this),n),this.simulator=new u(this.wgl,function(){f=!0,h&&f&&l.call(this)}.bind(this))}t.prototype.onMouseMove=function(t){var e=a.getMousePosition(t,this.canvas),r=e.x/this.canvas.width,i=e.y/this.canvas.height;this.mouseX=2*r-1,this.mouseY=2*(1-i)-1},t.prototype.reset=function(t,e,r,i,a,s,n){this.simulator.reset(t,e,r,i,a,s),this.renderer.reset(t,e,n)};var e=0;return t.prototype.update=function(t){var r=2*Math.atan(1/this.projectionMatrix[5]);e+=t;var i=[this.mouseX*Math.tan(r/2)*(this.canvas.width/this.canvas.height),this.mouseY*Math.tan(r/2),-1],s=i[0]*this.camera.distance,n=i[1]*this.camera.distance,o=s-this.lastMousePlaneX,u=n-this.lastMousePlaneY;e>5&&e<10&&(this.mouseX=1.4*Math.random()-.7,this.mouseY=-.45,o=50,u=100*Math.random()-50,e=0),this.lastMousePlaneX=s,this.lastMousePlaneY=n;var h=a.invertMatrix([],this.camera.getViewMatrix()),f=a.transformDirectionByMatrix([],i,h);a.normalizeVector(f,f);for(var l=this.camera.getViewMatrix(),c=[l[0],l[4],l[8]],E=[l[1],l[5],l[9]],T=[],m=0;m<3;++m)T[m]=o*c[m]+u*E[m];this.simulator.simulate(t,T,this.camera.getPosition(),f),this.renderer.draw(this.simulator,this.projectionMatrix,this.camera.getViewMatrix())},t.prototype.onResize=function(t){this.renderer.onResize(t)},t}(),f=function(){var t=Math.PI/3,e=0,r=1,o=60,u=40,f=4;function l(e,l,c,E){o=l.width||o,u=l.height||u,f=l.depth||f;var T=this.canvas=document.getElementById(e),m=this.wgl=new i(T);window.wgl=m,this.projectionMatrix=a.makePerspectiveMatrix(new Float32Array(16),t,this.canvas.width/this.canvas.height,.1,100),this.camera=new s(this.canvas,[o/2,u/3,f/2],c);var d=!1,p=!1;function _(t){this.state=r,this.currentPresetIndex=0,this.editedSinceLastPreset=!1;var e=[[new n.AABB([0,0,0],[15,20,20])]];this.editedSinceLastPreset=!1,this.boxEditor.boxes.length=0;for(var i=e[this.currentPresetIndex],a=0;a<i.length;++a)this.boxEditor.boxes.push(i[a].clone());this.gridCellDensity=.5,this.timeStep=1/60,T.addEventListener("mousemove",this.onMouseMove.bind(this)),window.addEventListener("resize",this.onResize.bind(this)),this.onResize();var s=0,o=function(t){var e=t-s||0;s=t,this.update(e),requestAnimationFrame(o)}.bind(this);o(),this.startSimulation(E.count,E.radius)}this.boxEditor=new n.BoxEditor(this.canvas,this.wgl,this.projectionMatrix,this.camera,[o,u,f],function(){(d=!0)&&p&&_.call(this)}.bind(this),function(){this.redrawUI()}.bind(this)),this.simulatorRenderer=new h(this.canvas,this.wgl,this.projectionMatrix,this.camera,[o,u,f],function(){p=!0,d&&p&&_.call(this)}.bind(this),E),this.startAnimation=function(){}.bind(this)}return l.prototype.onResize=function(e){this.canvas.width=window.innerWidth,this.canvas.height=window.innerHeight,a.makePerspectiveMatrix(this.projectionMatrix,t,this.canvas.width/this.canvas.height,.1,100),this.simulatorRenderer.onResize(e)},l.prototype.onMouseMove=function(t){t.preventDefault(),this.state===e?(this.boxEditor.onMouseMove(t),null!==this.boxEditor.interactionState&&(this.editedSinceLastPreset=!0)):this.state===r&&this.simulatorRenderer.onMouseMove(t)},l.prototype.getParticleCount=function(){for(var t=this.boxEditor,e=o*u*f*this.gridCellDensity,r=Math.ceil(Math.pow(e/2,1/3)),i=2*r*r*(1*r),a=0,s=[],n=0;n<t.boxes.length;++n){a+=t.boxes[n].computeVolume(),s[n]=a}return a/(o*u*f)*i*10},l.prototype.startSimulation=function(t,e){this.state=r;for(var i=t,a=Math.ceil(i/10),s=10*a,n=[],h=this.boxEditor,l=0,c=0;c<h.boxes.length;++c)l+=h.boxes[c].computeVolume();var E=0;for(c=0;c<h.boxes.length;++c){var T=h.boxes[c],m=0;m=c<h.boxes.length-1?Math.floor(s*T.computeVolume()/l):s-E;for(var d=0;d<m;++d){var p=T.randomPoint();n.push(p)}E+=m}var _=o*u*f*this.gridCellDensity,g=Math.ceil(Math.pow(_/2,1/3)),R=2*g,x=[o,u,f],A=[R,g,1*g],S=e/R;this.simulatorRenderer.reset(10,a,n,x,A,10,S),this.camera.setBounds(0,Math.PI/2)},l.prototype.stopSimulation=function(){this.state=e,this.camera.setBounds(-Math.PI/4,Math.PI/4)},l.prototype.update=function(){this.state===e?this.boxEditor.draw():this.state===r&&this.simulatorRenderer.update(this.timeStep)},l}();function l(t,e){var r=Object.keys(t);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(t);e&&(i=i.filter((function(e){return Object.getOwnPropertyDescriptor(t,e).enumerable}))),r.push.apply(r,i)}return r}function c(t){for(var e=1;e<arguments.length;e++){var r=null!=arguments[e]?arguments[e]:{};e%2?l(Object(r),!0).forEach((function(e){T(t,e,r[e])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(r)):l(Object(r)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(r,e))}))}return t}function E(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function T(t,e,r){return e in t?Object.defineProperty(t,e,{value:r,enumerable:!0,configurable:!0,writable:!0}):t[e]=r,t}var m={width:60,heigth:40,depth:4},d={distance:24,azimuth:-.009999999990000001,elevation:.004999999999999998},p={count:6e3,radius:7,color1:"#9466ff",color2:"#ff5e2d"},_=function t(){var e=this,r=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{},i=arguments.length>1&&void 0!==arguments[1]?arguments[1]:{},a=arguments.length>2&&void 0!==arguments[2]?arguments[2]:{};E(this,t),T(this,"initScene",(function(t){e.fluidBox=new f(t,e.initData.scene,e.initData.camera,e.initData.particles)})),T(this,"isEnableScene",(function(){var t=/Android|webOS|iPhone|iPad|iPod|Opera Mini/i.test(navigator.userAgent),e=document.createElement("canvas"),r=null;try{r=e.getContext("webgl")||e.getContext("experimental-webgl")}catch(t){return!1}return null!==r&&!t})),T(this,"startAnimation",(function(){fluidBox&&fluidBox.startSimulation()})),T(this,"stopAnimation",(function(){fluidBox&&fluidBox.stopSimulation()})),this.fluidBox=null,this.initData={scene:c({},m,{},r),camera:c({},d,{},i),particles:c({},p,{},a)}}}])}));